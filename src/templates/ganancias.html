{% extends "base.html" %}

{% block title %}Ganancias - ServiceAdmin{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>ðŸ’° Reporte de Ganancias</h1>
        <p>Resumen de ingresos por services</p>
    </div>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button class="btn btn-secondary btn-sm" onclick="cambiarMes(-1)">â—€</button>
        <span class="badge badge-info" style="font-size: 1rem; padding: 0.75rem 1rem;" id="mesActual">
            {{ mes_nombre }} {{ anio }}
        </span>
        <button class="btn btn-secondary btn-sm" onclick="cambiarMes(1)">â–¶</button>
    </div>
</div>

<!-- Resumen del mes -->
<div class="grid-4" style="margin-bottom: 2rem;">
    <div class="card stat-card">
        <div class="stat-value">{{ services|length }}</div>
        <div class="stat-label">Services del Mes</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value" style="color: var(--info);">${{ total_repuestos }}</div>
        <div class="stat-label">Total Repuestos</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value" style="color: var(--warning);">${{ total_mano_obra }}</div>
        <div class="stat-label">Total Mano de Obra</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value" style="color: var(--success);">${{ total_general }}</div>
        <div class="stat-label">Total del Mes</div>
    </div>
</div>

<!-- Lista de services del mes -->
<div class="card">
    <div class="card-header">
        <span class="card-title">ðŸ“‹ Detalle por Service</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>CÃ³digo</th>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th style="text-align: right;">Repuestos</th>
                    <th style="text-align: right;">Mano de Obra</th>
                    <th style="text-align: right;">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for service in services %}
                <tr>
                    <td>#{{ service.codService }}</td>
                    <td>{{ service.cliente.nombre }}</td>
                    <td>{{ service.nomProducto }}</td>
                    <td>{{ service.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <span class="badge {{ service.estado_badge_class }}">{{ service.estado }}</span>
                    </td>
                    <td style="text-align: right;">
                        {% if service.presupuesto %}
                        ${{ service.total_costo_repuestos }}
                        {% else %}
                        <span style="color: var(--gray-500);">-</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {% if service.presupuesto %}
                        ${{ service.presupuesto.manoDeObra }}
                        {% else %}
                        <span style="color: var(--gray-500);">-</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right; font-weight: 600;">
                        {% if service.presupuesto %}
                        <span style="color: var(--success);">
                            ${{ service.total_costo_repuestos + service.presupuesto.manoDeObra }}
                        </span>
                        {% else %}
                        <span style="color: var(--gray-500);">Sin presupuesto</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="empty-state">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <p>No hay services para este mes</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% if services|length > 0 %}
            <tfoot style="background: rgba(255,255,255,0.05); font-weight: 600;">
                <tr>
                    <td colspan="5" style="text-align: right;">TOTALES:</td>
                    <td style="text-align: right; color: var(--info);">${{ total_repuestos }}</td>
                    <td style="text-align: right; color: var(--warning);">${{ total_mano_obra }}</td>
                    <td style="text-align: right; color: var(--success); font-size: 1.1rem;">${{ total_general }}</td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</div>

<!-- SeparaciÃ³n por Cliente -->
{% set clientes_dict = {} %}
{% for service in services %}
    {% if service.cliente.nombre not in clientes_dict %}
        {% set _ = clientes_dict.update({service.cliente.nombre: []}) %}
    {% endif %}
    {% set _ = clientes_dict[service.cliente.nombre].append(service) %}
{% endfor %}

{% for cliente_nombre, cliente_services in clientes_dict.items() %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <span class="card-title">ðŸ‘¤ {{ cliente_nombre }}</span>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>CÃ³digo</th>
                    <th>Producto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th style="text-align: right;">Repuestos</th>
                    <th style="text-align: right;">Mano de Obra</th>
                    <th style="text-align: right;">Total</th>
                </tr>
            </thead>
            <tbody>
                {% set ns = namespace(rep_cliente=0, mo_cliente=0) %}
                {% for service in cliente_services %}
                {% if service.presupuesto %}
                    {% set ns.rep_cliente = ns.rep_cliente + service.total_costo_repuestos %}
                    {% set ns.mo_cliente = ns.mo_cliente + service.presupuesto.manoDeObra %}
                {% endif %}
                <tr>
                    <td>#{{ service.codService }}</td>
                    <td>{{ service.nomProducto }}</td>
                    <td>{{ service.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <span class="badge {{ service.estado_badge_class }}">{{ service.estado }}</span>
                    </td>
                    <td style="text-align: right;">
                        {% if service.presupuesto %}
                        ${{ service.total_costo_repuestos }}
                        {% else %}
                        <span style="color: var(--gray-500);">-</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        {% if service.presupuesto %}
                        ${{ service.presupuesto.manoDeObra }}
                        {% else %}
                        <span style="color: var(--gray-500);">-</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right; font-weight: 600;">
                        {% if service.presupuesto %}
                        <span style="color: var(--success);">
                            ${{ service.total_costo_repuestos + service.presupuesto.manoDeObra }}
                        </span>
                        {% else %}
                        <span style="color: var(--gray-500);">Sin presupuesto</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot style="background: rgba(16, 185, 129, 0.1); font-weight: 600;">
                <tr>
                    <td colspan="4" style="text-align: right;">SUBTOTAL {{ cliente_nombre }}:</td>
                    <td style="text-align: right; color: var(--info);">${{ ns.rep_cliente }}</td>
                    <td style="text-align: right; color: var(--warning);">${{ ns.mo_cliente }}</td>
                    <td style="text-align: right; color: var(--success); font-size: 1.1rem;">
                        ${{ ns.rep_cliente + ns.mo_cliente }}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% else %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <span class="card-title">ðŸ‘¤ SeparaciÃ³n por Cliente</span>
    </div>
    <div class="empty-state" style="padding: 2rem;">
        <div class="empty-state-icon">ðŸ“Š</div>
        <p>No hay services para mostrar por cliente este mes</p>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
    const mesActual = {{ mes }};
    const anioActual = {{ anio }};

    function cambiarMes(delta) {
        let nuevoMes = mesActual + delta;
        let nuevoAnio = anioActual;

        if (nuevoMes > 12) {
            nuevoMes = 1;
            nuevoAnio++;
        } else if (nuevoMes < 1) {
            nuevoMes = 12;
            nuevoAnio--;
        }

        window.location.href = `/ganancias?mes=${nuevoMes}&anio=${nuevoAnio}`;
    }
</script>
{% endblock %}